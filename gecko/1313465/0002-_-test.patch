From f8480f438148cb6b964426a2c9a1af0ad9d03788 Mon Sep 17 00:00:00 2001
From: Wei-Cheng Pan <wpan@mozilla.com>
Date: Mon, 13 Feb 2017 15:05:23 +0800
Subject: [PATCH 2/2] _ test

---
 dom/events/EventDispatcher.cpp               | 12 +++++++++++-
 toolkit/components/telemetry/Histograms.json | 27 +++++++++++++++++++++++++++
 2 files changed, 38 insertions(+), 1 deletion(-)

diff --git a/dom/events/EventDispatcher.cpp b/dom/events/EventDispatcher.cpp
index f8ca174df837..fceeb30668e6 100644
--- a/dom/events/EventDispatcher.cpp
+++ b/dom/events/EventDispatcher.cpp
@@ -626,7 +626,17 @@ EventDispatcher::Dispatch(nsISupports* aTarget,
   }
 #endif
 
-  if (auto inputEvent = aEvent->AsInputEvent()) {
+  if (auto wheelEvent = aEvent->AsWheelEvent()) {
+    if (wheelEvent->mFlags.mHandledByAPZ) {
+      Telemetry::AccumulateTimeDelta(Telemetry::APZ_SCROLLING_EVENT_RESPONSE_MS, wheelEvent->mTimeStamp);
+    } else {
+      Telemetry::AccumulateTimeDelta(Telemetry::MOUSE_EVENT_RESPONSE_MS, wheelEvent->mTimeStamp);
+    }
+  } else if (auto mouseEvent = aEvent->AsMouseEvent()) {
+    Telemetry::AccumulateTimeDelta(Telemetry::MOUSE_EVENT_RESPONSE_MS, mouseEvent->mTimeStamp);
+  } else if (auto keyboardEvent = aEvent->AsKeyboardEvent()) {
+    Telemetry::AccumulateTimeDelta(Telemetry::KEYBOARD_EVENT_RESPONSE_MS, keyboardEvent->mTimeStamp);
+  } else if (auto inputEvent = aEvent->AsInputEvent()) {
     Telemetry::AccumulateTimeDelta(Telemetry::INPUT_EVENT_RESPONSE_MS, inputEvent->mTimeStamp);
   }
 
diff --git a/toolkit/components/telemetry/Histograms.json b/toolkit/components/telemetry/Histograms.json
index d42678612828..8628389bb6be 100644
--- a/toolkit/components/telemetry/Histograms.json
+++ b/toolkit/components/telemetry/Histograms.json
@@ -10784,6 +10784,33 @@
     "description": "Records a value each time a tab that is showing the loading throbber is interrupted. Desktop only.",
     "labels": ["stop", "back", "forward", "historyNavigation", "reload", "tabClosed", "newURI"]
   },
+  "MOUSE_EVENT_RESPONSE_MS": {
+    "alert_emails": ["wpan@mozilla.com"],
+    "expires_in_version": "never",
+    "kind": "exponential",
+    "high": 10000,
+    "n_buckets": 100,
+    "bug_numbers": [1313465],
+    "description": "Input event latency."
+  },
+  "KEYBOARD_EVENT_RESPONSE_MS": {
+    "alert_emails": ["wpan@mozilla.com"],
+    "expires_in_version": "never",
+    "kind": "exponential",
+    "high": 10000,
+    "n_buckets": 100,
+    "bug_numbers": [1313465],
+    "description": "Input event latency."
+  },
+  "APZ_SCROLLING_EVENT_RESPONSE_MS": {
+    "alert_emails": ["wpan@mozilla.com"],
+    "expires_in_version": "never",
+    "kind": "exponential",
+    "high": 10000,
+    "n_buckets": 100,
+    "bug_numbers": [1313465],
+    "description": "Input event latency."
+  },
   "INPUT_EVENT_RESPONSE_MS": {
     "alert_emails": ["wpan@mozilla.com"],
     "expires_in_version": "never",
-- 
2.11.0

